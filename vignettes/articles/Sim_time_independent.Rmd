---
title: "Simulation of Time-independent Effects"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  out.width = "100%"
)

source(here::here("vignettes/articles/utils/utils_plotting.R"))
```

Load the necessary libraries and source the utility functions.

```{r setup, message=FALSE, warning=FALSE}
library(Survinng)
library(ggplot2)
library(cowplot)
library(dplyr)
library(tidyr)
library(survival)
library(survminer)
library(torch)
library(viridis)
library(here)
```


### Time-independent effects

## Generate the data

Simulation setting:
- $10,000$ samples ($9,500$ for training, $500$ for testing)
- No time-dependent effects
- $X_1 \sim \mathcal{N}(0,1)$ has a positive effect on the hazard -> negative effect on survival
- $X_2 \sim \mathcal{U}(0,1)$ has a stronger negative effect on the hazard -> positive effect on survival
- $X_3 \sim \mathcal{U}(-1,1)$ has no effect

## Load Models and Data

```{r td fit models, fig.width=10, fig.height=15}

# Load data
train <- readRDS(here("vignettes/articles/Sim_time_independent/train.rds"))
test <- readRDS(here("vignettes/articles/Sim_time_independent/test.rds"))
dat <- rbind(train, test)

# Load extracted models
ext_coxtime <- readRDS(here("vignettes/articles/Sim_time_independent/ext_coxtime.rds"))
ext_deepsurv <- readRDS(here("vignettes/articles/Sim_time_independent/ext_deepsurv.rds"))
ext_deephit <- readRDS(here("vignettes/articles/Sim_time_independent/ext_deephit.rds"))
```



## Create Explainer

```{r tid explainer}
exp_deephit <- Survinng::explain(ext_deephit[[1]], data = test)
exp_coxtime <- Survinng::explain(ext_coxtime[[1]], data = test)
exp_deepsurv <- Survinng::explain(ext_deepsurv[[1]], data = test)
```



## Performance

|Model | C-Index | IBS
|:---------:|:--------:|:--------:|
|CoxTime   | 0.809372   | 0.099053 |
|DeepSurv   | 0.809121   | 0.099031 |
|DeepHit   | 0.808829   | 0.141614 |

```{r echo=FALSE, out.width='80%'}
knitr::include_graphics(here('vignettes/articles/Sim_time_independent/sim_tid_brier_plot.png'))
```


### Survival Prediction

```{r survival pred, fig.width=10, fig.height=5}
# Print instances of interest
tid_ids <- c(13, 387)
print(test[tid_ids, ])

# Compute Vanilla Gradient
grad_cox <- surv_grad(exp_coxtime, target = "survival", instance = tid_ids)
grad_deephit <- surv_grad(exp_deephit, target = "survival", instance = tid_ids)
grad_deepsurv <- surv_grad(exp_deepsurv, target = "survival", instance = tid_ids)

# Plot survival predictions
surv_plot <- cowplot::plot_grid(
  plot_surv_pred(grad_cox) ,
  plot_surv_pred(grad_deephit),
  plot_surv_pred(grad_deepsurv),
  nrow = 1, labels = c("CoxTime", "DeepHit", "DeepSurv"),
  label_x = 0.03,      
  label_size = 14) 
surv_plot
```


## Explainable AI

### Gradient (Sensitivity)

```{r tid gradient, fig.width=10, fig.height=15}
# Plot attributions
grad_plot <- cowplot::plot_grid(
  plot_attribution(grad_cox, label = "Grad(t)") ,
  plot_attribution(grad_deephit, label = "Grad(t)"),
  plot_attribution(grad_deepsurv, label = "Grad(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
grad_plot
```

### SmoothGrad (Sensitivity)

```{r tid smoothgrad, fig.width=10, fig.height=15}
# Compute SmoothGrad
sg_cox <- surv_smoothgrad(exp_coxtime, target = "survival", instance = tid_ids, n = 50, noise_level = 0.1)
sg_deephit <- surv_smoothgrad(exp_deephit, target = "survival", instance = tid_ids, n = 50, noise_level = 0.1)
sg_deepsurv <- surv_smoothgrad(exp_deepsurv, target = "survival", instance = tid_ids, n = 50, noise_level = 0.1)

# Plot attributions
smoothgrad_plot <- cowplot::plot_grid(
  plot_attribution(sg_cox, label = "SG(t)"), 
  plot_attribution(sg_deephit, label = "SG(t)"), 
  plot_attribution(sg_deepsurv, label = "SG(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
smoothgrad_plot
```


### Gradient x Input

```{r tid gradientxinput, fig.width=10, fig.height=15}
# Compute GradientxInput
gradin_cox <- surv_grad(exp_coxtime, instance = tid_ids, times_input = TRUE)
gradin_deephit <- surv_grad(exp_deephit, instance = tid_ids, times_input = TRUE)
gradin_deepsurv <- surv_grad(exp_deepsurv, instance = tid_ids, times_input = TRUE)

# Plot attributions
gradin_plot <- cowplot::plot_grid(
  plot_attribution(gradin_cox, label = "GxI(t)"), 
  plot_attribution(gradin_deephit, label = "GxI(t)"), 
  plot_attribution(gradin_deepsurv, label = "GxI(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
gradin_plot
```

```{r tid gradient and gradientin, fig.width=10, fig.height=10}
# Plot attributions
grad_gradin_plot <- cowplot::plot_grid(
  plot_attribution(grad_deepsurv, label = "Grad(t)") ,
  plot_attribution(gradin_deepsurv, label = "GxI(t)"),
  nrow = 2, labels = c("DeepSurv", "DeepSurv"))
grad_gradin_plot
```

### SmoothGrad x Input

```{r tid smoothgradxinput, fig.width=10, fig.height=15}
# Compute SmoothGradxInput
sgin_cox <- surv_smoothgrad(exp_coxtime, instance = tid_ids, n = 50, noise_level = 0.3,
                          times_input = TRUE)
sgin_deephit <- surv_smoothgrad(exp_deephit, instance = tid_ids, n = 50, noise_level = 0.3,
                              times_input = TRUE)
sgin_deepsurv <- surv_smoothgrad(exp_deepsurv, instance = tid_ids, n = 50, noise_level = 0.3,
                               times_input = TRUE)

# Plot attributions
smoothgradin_plot <- cowplot::plot_grid(
  plot_attribution(sgin_cox, label = "SGxI(t)"), 
  plot_attribution(sgin_deephit, label = "SGxI(t)"), 
  plot_attribution(sgin_deepsurv, label = "SGxI(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
smoothgradin_plot
```

### IntegratedGradient

## Zero baseline (should be proportional to Gradient x Input)

```{r tid intgrad0, fig.width=10, fig.height=15}
# Compute IntegratedGradient with 0 baseline
x_ref <- matrix(c(0,0,0), nrow = 1)
ig0_cox <- surv_intgrad(exp_coxtime, instance = tid_ids, n = 50, x_ref = x_ref)
ig0_deephit <- surv_intgrad(exp_deephit, instance = tid_ids, n = 50, x_ref = x_ref)
ig0_deepsurv <- surv_intgrad(exp_deepsurv, instance = tid_ids, n = 50, x_ref = x_ref)

# Plot attributions
intgrad0_plot <- cowplot::plot_grid(
  plot_attribution(ig0_cox, label = "IntGrad(t)"), 
  plot_attribution(ig0_deephit, label = "IntGrad(t)"), 
  plot_attribution(ig0_deepsurv, label = "IntGrad(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
intgrad0_plot
```

```{r tid intgrad0 comp, fig.width=10, fig.height=15}
# Plot attributions
intgrad0_plot_comp <- cowplot::plot_grid(
  plot_attribution(ig0_cox, add_comp = TRUE, label = "IntGrad(t)"), 
  plot_attribution(ig0_deephit, add_comp = TRUE, label = "IntGrad(t)"), 
  plot_attribution(ig0_deepsurv, add_comp = TRUE, label = "IntGrad(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
intgrad0_plot_comp
```

```{r tid intgrad0 contr, fig.width=10, fig.height=15}
# Plot contributions
intgrad0_plot_contr <- cowplot::plot_grid(
  plot_contribution(ig0_cox, label = "IntGrad(t)"), 
  plot_contribution(ig0_deephit, label = "IntGrad(t)"), 
  plot_contribution(ig0_deepsurv, label = "IntGrad(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
intgrad0_plot_contr
```

```{r tid intgrad0 force, fig.width=10, fig.height=15}
# Plot force
intgrad0_plot_force <- cowplot::plot_grid(
  plot_force(ig0_cox, upper_distance = 0.04, lower_distance = 0.04, label = "IntGrad(t)"), 
  plot_force(ig0_deephit, upper_distance = 0.02, lower_distance = 0, label = "IntGrad(t)"), 
  plot_force(ig0_deepsurv, upper_distance = 0.04, lower_distance = 0.04, label = "IntGrad(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
intgrad0_plot_force
```

## Mean baseline

```{r tid intgradmean, fig.width=10, fig.height=15}
# Compute IntegratedGradient with mean baseline
x_ref <- NULL # default: feature-wise mean
igm_cox <- surv_intgrad(exp_coxtime, instance = tid_ids, n = 50, x_ref = x_ref)
igm_deephit <- surv_intgrad(exp_deephit, instance = tid_ids, n = 50, x_ref = x_ref)
igm_deepsurv <- surv_intgrad(exp_deepsurv, instance = tid_ids, n = 50, x_ref = x_ref)

# Plot attributions
intgradmean_plot <- cowplot::plot_grid(
  plot_attribution(igm_cox, label = "IntGrad(t)"), 
  plot_attribution(igm_deephit, label = "IntGrad(t)"), 
  plot_attribution(igm_deepsurv, label = "IntGrad(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
intgradmean_plot
```

```{r tid intgradmean comp, fig.width=10, fig.height=15}
# Plot attributions
intgradmean_plot_comp <- cowplot::plot_grid(
  plot_attribution(igm_cox, add_comp = TRUE, label = "IntGrad(t)"), 
  plot_attribution(igm_deephit, add_comp = TRUE, label = "IntGrad(t)"), 
  plot_attribution(igm_deepsurv, add_comp = TRUE, label = "IntGrad(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
intgradmean_plot_comp
```

```{r tid intgradmean contr, fig.width=10, fig.height=15}
# Plot contributions
intgradm_plot_contr <- cowplot::plot_grid(
  plot_contribution(igm_cox, label = "IntGrad(t)"), 
  plot_contribution(igm_deephit, label = "IntGrad(t)"), 
  plot_contribution(igm_deepsurv, label = "IntGrad(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
intgradm_plot_contr
```

```{r tid intgradmean force, fig.width=10, fig.height=15}
# Plot force
intgradm_plot_force <- cowplot::plot_grid(
  plot_force(igm_cox, upper_distance = 0, lower_distance = 0, label = "IntGrad(t)"), 
  plot_force(igm_deephit, upper_distance = 0, lower_distance = 0, label = "IntGrad(t)"), 
  plot_force(igm_deepsurv, upper_distance = 0, lower_distance = 0, label = "IntGrad(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
intgradm_plot_force
```


### GradShap

```{r tid gradshap, fig.width=10, fig.height=15}
# Compute GradShap
gshap_cox <- surv_gradSHAP(exp_coxtime, instance = tid_ids, n = 50, num_samples = 100)
gshap_deephit <- surv_gradSHAP(exp_deephit, instance = tid_ids, n = 50, num_samples = 100)
gshap_deepsurv <- surv_gradSHAP(exp_deepsurv, instance = tid_ids, n = 50, num_samples = 100)

# Plot attributions
gshap_plot <- cowplot::plot_grid(
  plot_attribution(gshap_cox, label = "GradSHAP(t)"), 
  plot_attribution(gshap_deephit, label = "GradSHAP(t)"), 
  plot_attribution(gshap_deepsurv, label = "GradSHAP(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
gshap_plot
```

```{r tid gradshap comp, fig.width=10, fig.height=15}
# Plot attributions
gshap_plot_comp <- cowplot::plot_grid(
  plot_attribution(gshap_cox, add_comp = TRUE, label = "GradSHAP(t)"), 
  plot_attribution(gshap_deephit, add_comp = TRUE, label = "GradSHAP(t)"), 
  plot_attribution(gshap_deepsurv, add_comp = TRUE, label = "GradSHAP(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
gshap_plot_comp
```

```{r tid gradshap contr, fig.width=10, fig.height=15}
# Plot contributions %
gshap_plot_contr <- cowplot::plot_grid(
  plot_contribution(gshap_cox, label = "GradSHAP(t)"), 
  plot_contribution(gshap_deephit, label = "GradSHAP(t)"), 
  plot_contribution(gshap_deepsurv, label = "GradSHAP(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
gshap_plot_contr
```

```{r tid gradshap force, fig.width=10, fig.height=15}
# Plot force
gshap_plot_force <- cowplot::plot_grid(
  plot_force(gshap_cox, upper_distance = 0, lower_distance = 0, lower_distance_x1 = 0.05, label = "GradSHAP(t)"), 
  plot_force(gshap_deephit, upper_distance = 0, lower_distance = 0, lower_distance_x1 = 0.02, label = "GradSHAP(t)"), 
  plot_force(gshap_deepsurv, upper_distance = 0, lower_distance = 0, lower_distance_x1 = 0.04, label = "GradSHAP(t)"),
  nrow = 3, labels = c("CoxTime", "DeepHit", "DeepSurv"))
gshap_plot_force
```

